//--------------------------------------------------------------------------------
// @file   AutoIR.h
// @brief  自動赤外線リモコンクラス
//--------------------------------------------------------------------------------

#pragma once
// RTC
#include "RTClib.h"
// LCD
#include "LCD_ST7032.h"
// Encoder
#include "Encoder.h"


class AutoIR{
    public:
    //--------------------------------------------------------------------------------
        explicit AutoIR(){}
        
        //--------------------------------------------------------------------------------
        //! @brief  初回起動時の設定
        //--------------------------------------------------------------------------------
        struct InitArg{
            int mPIN_SW;
            int mPIN_LCD_BACKLIGHT;
            int mPIN_ENCODER_A;
            int mPIN_ENCODER_B;
        };
        bool setup(const InitArg& arg);

        //--------------------------------------------------------------------------------
        //! @brief  メインループ
        //--------------------------------------------------------------------------------
        void loop();
    
    private:
    //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        //! @brief  RTCを初期化
        //! @return 初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initRTC_();

        //--------------------------------------------------------------------------------
        //! @brief   現在の時刻を文字列として取得
        //! @param   outChar 出力先バッファのポインタ
        //! @return  出力先バッファのポインタ
        //--------------------------------------------------------------------------------
        char* getTimeStr_(char* outChar);
        
        //--------------------------------------------------------------------------------
        //! @brief  LCDを初期化
        //! @return 初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initLCD_();
        
        //--------------------------------------------------------------------------------
        //! @brief  LCDに文字を表示
        //! @param  str 表示する文字列
        //--------------------------------------------------------------------------------
        void dispLCD_(const char* str, int line);
        
        //--------------------------------------------------------------------------------
        //! @brief  LCDの輝度を調整
        //! @param  targetV セットする電圧（0～3.3V）
        //--------------------------------------------------------------------------------
        void setLCDBlightness_(float targetV);

        //--------------------------------------------------------------------------------
        //! @brief  ロータリーエンコーダを初期化
        //! @return 初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initEncoder_();

        //--------------------------------------------------------------------------------
        //! @brief   ロータリーエンコーダの入力を計算
        //! @param   encoder ロータリーエンコーダのインスタンス
        //--------------------------------------------------------------------------------
        void calcEncoderInput_();

        //--------------------------------------------------------------------------------
        //! @brief   スイッチの初期化
        //! @return  初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initSW_();

        //--------------------------------------------------------------------------------
        //! @brief   スイッチがONか
        //! @return  ONならtrue
        //--------------------------------------------------------------------------------
        bool isSwitchON_() const;

    private:
    //--------------------------------------------------------------------------------
        InitArg    mInitArg;
        RTC_DS3231 mRTC;
        LCD_ST7032 mLCD;
        Encoder    mEncoder;
        int        mCounter;
        DateTime   mAlarmTime;
    //--------------------------------------------------------------------------------
};