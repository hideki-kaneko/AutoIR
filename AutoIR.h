//--------------------------------------------------------------------------------
// @file   AutoIR.h
// @brief  自動赤外線リモコンクラス
//--------------------------------------------------------------------------------

#pragma once
// RTC
#include "RTClib.h"
// LCD
#include "LCD_ST7032.h"
// Encoder
#include "Encoder.h"

// Encoder encoder // Encoder.hの中で定義済

class AutoIR{
    public:
    //--------------------------------------------------------------------------------
        explicit AutoIR(){}
        
        //--------------------------------------------------------------------------------
        //! @brief  初回起動時の設定
        //--------------------------------------------------------------------------------
        struct InitArg{
            int mPIN_SW;
            int mPIN_LCD_BACKLIGHT;
            int mPIN_IR_SEND;
        };
        bool setup(const InitArg& arg);

        //--------------------------------------------------------------------------------
        //! @brief  メインループ
        //--------------------------------------------------------------------------------
        void loop();
        
        //! ステート
        enum State{
            Active,     // 動作中
            Edit        // アラーム設定中
        };
    
    private:
    //--------------------------------------------------------------------------------
        //--------------------------------------------------------------------------------
        //! @brief  RTCを初期化
        //! @return 初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initRTC_();
        
        //--------------------------------------------------------------------------------
        //! @brief  LCDを初期化
        //! @return 初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initLCD_();
        
        //--------------------------------------------------------------------------------
        //! @brief   LCDの情報を更新
        //--------------------------------------------------------------------------------
        void updateLCD_();

        //--------------------------------------------------------------------------------
        //! @brief  LCDの輝度を調整
        //! @param  targetV セットする電圧（0～3.3V）
        //--------------------------------------------------------------------------------
        void setLCDBlightness_(float targetV);

        //--------------------------------------------------------------------------------
        //! @brief  ロータリーエンコーダを初期化
        //! @return 初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initEncoder_();

        //--------------------------------------------------------------------------------
        //! @brief   ロータリーエンコーダの入力を計算
        //! @param   encoder ロータリーエンコーダのインスタンス
        //--------------------------------------------------------------------------------
        void calcEncoderInput_();

        //--------------------------------------------------------------------------------
        //! @brief   スイッチの初期化
        //! @return  初期化に成功したか
        //--------------------------------------------------------------------------------
        bool initSW_();

        //--------------------------------------------------------------------------------
        //! @brief   スイッチがONか
        //! @return  ONならtrue
        //--------------------------------------------------------------------------------
        bool isSwitchON_() const;

        //--------------------------------------------------------------------------------
        //! @brief   ステートを更新
        //--------------------------------------------------------------------------------
        void updateState_();

        //--------------------------------------------------------------------------------
        //! @brief   アラームの時刻をEEPROMに保存
        //--------------------------------------------------------------------------------
        void saveAlarmTime_();

        void loadAlarmTime_();

        void sendIR_();

    private:
    //--------------------------------------------------------------------------------
        InitArg    mInitArg;
        RTC_DS3231 mRTC;
        LCD_ST7032 mLCD;
        int        mCounter;
        DateTime   mAlarmTime;
        State      mState;
    //--------------------------------------------------------------------------------
};